function HoaxyGraph(e){var t={},n=(e.spinStart,e.spinStop||function(){console.log("HoaxyGraph.spinStop is undefined.")}),o=e.toggle_edge_modal||function(){console.log("HoaxyGraph.toggle_edge_modal is undefined.")},i=e.toggle_node_modal||function(){console.log("HoaxyGraph.toggle_node_modal is undefined.")},r=e.node_modal_content||{},s=e.edge_modal_content||{},a=(e.twitter_account_info,e.spinner_notices||{}),c=e.twitter||null,u=e.getting_bot_scores||!1,d=e.graphAnimation||{playing:!1,increment:0,total_increments:40},_=e.twitterRateLimitReached,g={start_time:0,end_time:0},l={user_list:[],current_index:0,total:0,found:0,old:0,unavailable:0,reset:function(){this.total=this.found=this.old=this.unavailable=0},recompute:function(){for(var e in this.found=this.old=this.unavailable=0,w)if(this.user_list.indexOf(e)>-1){var t=w[e];-1===t.score?this.unavailable+=1:!0===t.old?(this.old+=1,this.found+=1):this.found+=1}this.total=this.user_list.length}},m=null,h={},f=[],p=[],w={},v=0;var b=0;var y=0;function x(e){function t(){w[e.user_id]={score:-1,old:!0},z(e.user_id,w[e.user_id].score),l.recompute()}return new Promise(function(n,o){(e.score&&(z(e.user_id,e.score),n()),!e.score||e.old)&&function(e){var t={},n=m.graph.nodes(e).data.screenName;return botScoreA=new Promise(function(o,i){var s=new Promise(function(n,o){c.getUserDataById(e).then(function(e){t.user=e,c.getUserMentions(t.user.screen_name).then(function(e){e.statuses?t.mentions=e.statuses:t.mentions=e,n()},function(){}).catch(S)},function(){}).catch(S)},function(){}).catch(S),a=c.getUserTimelineById(e);a.then(function(e){t.timeline=e},function(){}).catch(S),Promise.all([s,a]).then(function(e){var s,a,c,u,d;(a=n,c=(s=t).user.screen_name,u=s.user.id_str,(d=axios({method:"post",url:configuration.botometer_url,headers:configuration.botometer_headers,responseType:"json",data:s})).then(function(e){var t=e.data.user.id_str,n=0;if(n="en"==e.data.user.lang||"en-gb"==e.data.user.lang?e.data.scores.english:e.data.scores.universal,a!=e.data.user.screen_name)var o=a,i=e.data.user.screen_name,s=!0;else o=a,i="unchanged",s=!1;var d=Math.round(100*e.data.cap.english);r.staleAcctInfo.newId=t,r.staleAcctInfo.oldSn=o,r.staleAcctInfo.newSn=i,r.staleAcctInfo.isStale=s,r.completeAutomationProbability=d,w[u]={score:n,old:!1,time:new Date,user_id:e.data.user.id,screen_name:c,completeAutomationProbability:d,staleAcctInfo:{isStale:s,newId:t,oldSn:o,newSn:i}},r.showStaleContent=!0,z(u,w[u].score)},function(e){console.debug("Could not get bot score for "+c+": ",e)}),d).then(o,i)},function(e){console.warn("Could not get bot score for "+n+": ",e),i(e)})},S),botScoreA}(e.user_id).then(function(e){l.recompute(),n(e)},function(e){e.error&&429==e.error.status?o("Error: rate limit reached"):(t(),o())})}).then(function(e){return e},function(e){return e})}function S(e){console.warn(e)}function z(e,t){(color=N(t),m&&m.graph)&&(m.graph.nodes(e)&&(m.graph.nodes(e).color=color,m.graph.nodes(e).borderColor=q(t),I()))}var A=0;function I(){clearTimeout(A),A=setTimeout(function(){m.refresh({skipIndexation:!0})},100)}function T(e){if(null==e)return colors.node_colors.fact_checking;if(!1===e)return{r:255,g:255,b:255};if(e<0)return{r:230,g:230,b:230};e*=100;var t=colors.node_colors.botscores;var n={};return(n=e<20?t[4]:e<40?t[3]:e<60?t[2]:e<80?t[1]:t[0]).r=n.red,n.g=n.green,n.b=n.blue,n}function N(e){var t=T(e);return"rgb("+t.r+", "+t.g+", "+t.b+")"}function q(e){var t=120;!1===e&&(t=50);var n=T(e);return n.r=n.r-t,n.r<0&&(n.r=0),n.g=n.g-t,n.g<0&&(n.g=0),n.b=n.b-t,n.b<0&&(n.b=0),"rgb("+n.r+", "+n.g+", "+n.b+")"}function C(){m&&(m.kill(),m=null),document.getElementById("graph-container").innerHTML=""}function M(){v++,m=new sigma({graph:h,container:"graph-container",renderer:{container:document.getElementById("graph-container"),type:"canvas"},settings:{autoRescale:!0,scalingMode:"inside",edgeHoverExtremities:!0,borderSize:1,minArrowSize:6,labelThreshold:8,enableEdgeHovering:!0,edgeHoverSizeRatio:2,singleHover:!0,rescaleIgnoreSize:!0,defaultNodeType:"border",zoomingRatio:1.2}});var e=600*Math.floor(Math.sqrt(h.edges.length));for(var t in m.refresh({skipIndexation:!0}),m.startForceAtlas2({slowDown:100,gravity:2}),w)z(t,w[t].score);n("generateNetwork"),setTimeout(function(){v<2?(m.stopForceAtlas2(),m.camera.goTo({x:0,y:0,ratio:1}),n("ForceAtlas"),a.graph="",v--):v--},2e3+e),m.bind("clickNode",function(e){var t=e.data.node.data;r.user_id=e.data.node.id,r.screenName=t.screenName,r.staleAcctInfo.openedModalWhileFetchingScores=u.running;var n=!1;if(w[t.id]){w[t.id];n=w[t.id].score,n=Math.floor(100*n),r.botcolor=0!=n?N(n/100):"",r.botscore=n,r.timestamp=w[t.id].time,w[t.id].hasOwnProperty("staleAcctInfo")&&w[t.id].hasOwnProperty("completeAutomationProbability")?(r.staleAcctInfo.isStale=w[t.id].staleAcctInfo.isStale,r.staleAcctInfo.newId=w[t.id].staleAcctInfo.newId,r.staleAcctInfo.oldSn=w[t.id].staleAcctInfo.oldSn,r.staleAcctInfo.newSn=w[t.id].staleAcctInfo.newSn,r.completeAutomationProbability=w[t.id].completeAutomationProbability,r.showStaleContent=!0):r.showStaleContent=!1}else r.showStaleContent=!1,r.botscore=!1,r.botcolor="";!function(e){var t=e.data.node.data,n={is_mentioned_by:{},has_quoted:{},has_retweeted:{},has_mentioned:{},is_quoted_by:{},is_retweeted_by:{}},o={is_mentioned_by_count:0,has_quoted_count:0,has_retweeted_count:0,has_mentioned_count:0,is_quoted_by_count:0,is_retweeted_by_count:0};for(var i in t.incoming){var s="https://twitter.com/intent/user?user_id="+String(i),a="https://twitter.com/intent/user?user_id="+e.data.node.id;for(var c in t.incoming[i].ids){var u=TWEET_URL.replace("%0",i).replace("%1",t.incoming[i].ids[c]);1!=t.incoming[i].is_mentions[c]&&0!=t.incoming[i].is_mentions[c]&&console.log("GenerateUserModal Parse incoming.is_mentions error!!");var d="";1==t.incoming[i].is_mentions[c]||"reply"==t.incoming[i].tweet_types[c]?d="is_mentioned_by":"quote"==t.incoming[i].tweet_types[c]?d="has_quoted":"retweet"==t.incoming[i].tweet_types[c]&&(d="has_retweeted"),n[d][i]=n[d][i]||{user_url:s,screenName:t.incoming[i].screenName,article_titles:[],tweet_urls:[],article_urls:[]},n[d][i].article_titles.push(t.incoming[i].titles[c]),n[d][i].tweet_urls.push(u),n[d][i].article_urls.push(t.incoming[i].url_raws[c]),o[d+"_count"]++}}for(var i in t.outgoing)for(var c in s="https://twitter.com/intent/user?user_id="+e.data.node.id,a="https://twitter.com/intent/user?user_id="+String(i),t.outgoing[i].ids)u=TWEET_URL.replace("%0",i).replace("%1",t.outgoing[i].ids[c]),1!=t.outgoing[i].is_mentions[c]&&0!=t.outgoing[i].is_mentions[c]&&console.log("GenerateUserModal Parse outgoing.is_mentions error!!"),d="",1==t.outgoing[i].is_mentions[c]||"reply"==t.outgoing[i].tweet_types[c]?d="has_mentioned":"quote"==t.outgoing[i].tweet_types[c]?d="is_quoted_by":"retweet"==t.outgoing[i].tweet_types[c]&&(d="is_retweeted_by"),n[d][i]=n[d][i]||{user_url:a,screenName:t.outgoing[i].screenName,article_titles:[],tweet_urls:[],article_urls:[]},n[d][i].article_titles.push(t.outgoing[i].titles[c]),n[d][i].tweet_urls.push(u),n[d][i].article_urls.push(t.outgoing[i].url_raws[c]),o[d+"_count"]++;r.is_mentioned_by=n.is_mentioned_by,r.has_quoted=n.has_quoted,r.has_retweeted=n.has_retweeted,r.has_mentioned=n.has_mentioned,r.is_quoted_by=n.is_quoted_by,r.is_retweeted_by=n.is_retweeted_by,r.is_mentioned_by_count=o.is_mentioned_by_count,r.has_quoted_count=o.has_quoted_count,r.has_retweeted_count=o.has_retweeted_count,r.has_mentioned_count=o.has_mentioned_count,r.is_quoted_by_count=o.is_quoted_by_count,r.is_retweeted_by_count=o.is_retweeted_by_count}(e),i()}),m.bind("clickEdge",function(e){var t=e.data.edge;s.edge=t;for(var n={},i={mention:0,quote:0,retweet:0},r=0;r<t.outgoing_ids.length;++r){var a=t.tweet_types[r];"reply"==a&&(a="mention"),"origin"==a&&(a="mention"),++i[a],n[t.outgoing_ids[r]]=TWEET_URL.replace("%0",t.target).replace("%1",t.outgoing_ids[r])}s.tweet_urls=n;var c="",u=0;for(var d in i)i.hasOwnProperty(d)&&i[d]>0&&(0==u++?c+=" ":c+=", ","mention"==d?c+="mentioned":"retweet"==d?c+="was retweeted by":"quote"==d&&(c+="was quoted by"));s.label_string=c,o()})}function k(e){e=e||g.end_time;var t=[],n=m.graph.edges(),o=m.graph.nodes(),i={fact_checking:colors.edge_colors.fact_checking,claim:colors.edge_colors.claim},r={},s=0,a=0;for(var c in n){var u=n[c];0,u.min_tweet_created_at>=e?(0,u.color="rgba(0,0,0,.05)"):(r[u.target]=r[u.target]||0,r[u.source]=r[u.source]||0,r[u.target]+=1,r[u.source]+=1,u.color=i[u.edge_type],t.push(u.target),t.push(u.source))}for(var c in r)0,r[c]>s&&(s=r[c]),r[c]<a&&(a=r[c]);for(var c in o){var d,_=o[c];if(-1===t.indexOf(_.id))_.color="rgba(0,0,0,.05)",_.borderColor="rgba(0,0,0,.05)",(d=1e3*(Math.sqrt(a)/Math.sqrt(s))+1)<300&&(d=300),_.size=d;else(d=1e3*(Math.sqrt(r[_.id])/Math.sqrt(s))+1)<300&&(d=300),_.size=d,score=!1,w[_.id]&&(score=w[_.id].score),z(_.id,score)}I()}(function(e){sigma.canvas.nodes.border=function(e,t,n){var o=n("prefix")||"";t.fillStyle=e.color||n("defaultNodeColor"),t.beginPath(),t.arc(e[o+"x"],e[o+"y"],e[o+"size"],0,2*Math.PI,!0),t.closePath(),t.fill(),t.lineWidth=.5,t.strokeStyle=e.borderColor||q(!1),t.stroke()}}).call(this),d.playing=!1,d.paused=!1,d.increment=0;var P=0;function E(e){if(d.current_timestamp=e,k(e),e>g.end_time||d.increment>d.total_increments)return k((new Date).getTime()),d.increment=0,d.playing=!1,!1;var t=e+(g.end_time-g.start_time)/d.total_increments;P=setTimeout(function(){d.increment+=1,E(t)},120)}return t.filter=k,t.startAnimation=function(){console.debug(g),d.increment=1,d.playing=!0,d.paused=!1,E(g.start_time)},t.stopAnimation=function(){clearTimeout(P),d.current_timestamp>g.start_time&&k((new Date).getTime()),d.playing=!1,d.paused=!1},t.pauseAnimation=function(){clearTimeout(P),d.paused=!0},t.unpauseAnimation=function(){d.paused=!1,E(d.current_timestamp)},t.updateEdges=function(e){return 0===(f=e).length?(C(),f):f},t.updateGraph=function(e,t){if(clearTimeout(P),C(),!f||!f.length)throw"Tried to make graph, but there is no data.";var n={nodes:[],edges:[]},o=colors.node_colors,i={fact_checking:colors.edge_colors.fact_checking,claim:colors.edge_colors.claim},r={},s={};h=n,g.start_time=0,g.end_time=0;var a=0;try{for(var c in f){var u=f[c],d=u.from_user_id,_=u.to_user_id,m=u.tweet_id,p=u.tweet_type,v=u.is_mention,b=new Date(u.tweet_created_at).getTime();if(!(e&&b<e||t&&b>t)){(!g.start_time||b<g.start_time)&&(g.start_time=b),(!g.end_time||b>g.end_time)&&(g.end_time=b),e&&t&&(g.start_time=e,g.end_time=t);var y=u.url_raw,x=u.title;-1!=_&&(r[d]=r[d]||{id:"",size:1,color:"",incomingCount:0,outgoingCount:0,screenName:"",incoming:{},outgoing:{},edges:[]},r[d].id=d,r[d].size++,r[d].color=o[u.site_type],r[d].screenName=u.from_user_screen_name,r[d].edges.push("e"+c),r[d].outgoing[_]=r[d].outgoing[_]||{type:"",fact_checking:0,claim:0,screenName:"",count:0,min_tweet_created_at:(new Date).getTime(),max_tweet_created_at:0,is_mentions:[],tweet_types:[],ids:[],url_raws:[],titles:[]},r[d].outgoing[_][u.site_type]++,r[d].outgoing[_].type=r[d].outgoing[_].fact_checking>r[d].outgoing[_].claim?"fact_checking":"claim",r[d].outgoing[_].screenName=u.to_user_screen_name,r[d].outgoing[_].count++,r[d].outgoing[_].min_tweet_created_at=Math.min(b,r[d].outgoing[_].min_tweet_created_at),r[d].outgoing[_].max_tweet_created_at=Math.max(b,r[d].outgoing[_].max_tweet_created_at),r[d].outgoing[_].is_mentions.push(v),r[d].outgoing[_].tweet_types.push(p),r[d].outgoing[_].ids.push(m),r[d].outgoing[_].url_raws.push(y),r[d].outgoing[_].titles.push(x),r[d].outgoingCount++,r[_]=r[_]||{id:"",size:1,color:"",incomingCount:0,outgoingCount:0,screenName:"",incoming:{},outgoing:{},edges:[]},r[_].id=_,r[_].color=o[u.site_type],r[_].screenName=u.to_user_screen_name,r[_].edges.push("e"+c),r[_].incoming[d]=r[_].incoming[d]||{type:"",fact_checking:0,claim:0,screenName:"",count:0,is_mentions:[],tweet_types:[],ids:[],url_raws:[],titles:[]},r[_].incoming[d][u.site_type]++,r[_].incoming[d].type=r[_].incoming[d].fact_checking>r[_].incoming[d].claim?"fact_checking":"claim",r[_].incoming[d].screenName=u.from_user_screen_name,r[_].incoming[d].count++,r[_].incoming[d].is_mentions.push(v),r[_].incoming[d].tweet_types.push(p),r[_].incoming[d].ids.push(m),r[_].incoming[d].url_raws.push(y),r[_].incoming[d].titles.push(x),r[_].incomingCount++,s[d+" "+_]=s[d+" "+_]||0,s[d+" "+_]+=1,s[d+" "+_])}}var S=0,z=0;for(var c in a=0,r)a++,r[c].size>S&&(S=r[c].size),r[c].size<z&&(z=r[c].size);var A={},I=0;l.unavailable=0,l.old=0,l.found=0;var T=[],q=[],k=[],E=[];for(var c in l.user_list=[],r){var R=Math.sqrt(r[c].size)/Math.sqrt(S)*1e3+1;R<300&&(R=300);var B=w[r[c].id];B&&B.score?(-1===B.score?(k.push(r[c].id),l.unavailable+=1):!0===B.old?(q.push(r[c].id),l.old+=1,l.found+=1):(T.push(r[c].id),l.found+=1),B=B.score):(k.push(r[c].id),B=!1);var O,H,L=N(B);O=Math.cos(2*Math.PI*(I/a)),H=Math.sin(2*Math.PI*(I/a)),n.nodes.push({x:O,y:H,orig_size:r[c].size,size:R,label:r[c].screenName,id:c,node_id:I,color:L,data:r[c]}),A[c]=I,++I}var U=k.length;for(c=0;c<U;c++)E.push(k[c]);var D=q.length;for(c=0;c<D;c++)E.push(q[c]);for(l.current_index=T.length,c=0;c<l.current_index;c++)l.user_list.push(T[c]);for(toComputeLen=E.length,c=0;c<toComputeLen;c++)l.user_list.push(E[c]);a=n.nodes.length,l.total=a;var G=0;for(var c in r)for(var W in r[c].outgoing)n.edges.push({id:"e"+G,source:c,target:W,source_screenName:r[c].screenName,target_screenName:r[W].screenName,from_node_id:A[c],to_node_id:A[W],size:Number(r[c].outgoing[W].count),type:"arrow",edge_type:r[c].outgoing[W].type,color:i[r[c].outgoing[W].type],count:G,min_tweet_created_at:r[c].outgoing[W].min_tweet_created_at,max_tweet_created_at:r[c].outgoing[W].max_tweet_created_at,outgoing_ids:r[c].outgoing[W].ids,incoming_ids:r[W].incoming[c].ids,url_raws:r[c].outgoing[W].url_raws,titles:r[c].outgoing[W].titles,tweet_types:r[c].outgoing[W].tweet_types}),++G;n.edges.length}catch(e){console.debug(e)}return h=n,M(),h},t.getNewScores=function(){u.running=!0,y=20,function e(t){if(y<=0)return l.current_index=t,u.running=!1,!1;if(y-=1,t>=l.user_list.length)return console.debug(w),console.debug("end of list"),u.running=!1,!1;var n=l.user_list[t],o=m.graph.nodes(n),i=o.data.screenName,r={screen_name:i,user_id:n};w[n]&&(r.score=w[n].score,r.old=w[n].old);var s=new Promise(function(e,t){x(r).then(e,t)});return s.then(function(e){_.isReached="Error: rate limit reached"===e}),t++,setTimeout(function(){e(t)},1e3)}(l.current_index)},t.getBotCacheScores=function e(){if(void 0===h.nodes)return setTimeout(function(){e()},100),!1;for(var t in u.running=!0,l.user_list.length=0,p.length=0,f){var o=f[t];o.from_user_screen_name,o.to_user_screen_name,from_user_id=o.from_user_id,to_user_id=o.to_user_id,l.user_list.indexOf(from_user_id)<0&&l.user_list.push(from_user_id),l.user_list.indexOf(to_user_id)<0&&l.user_list.push(to_user_id),p.indexOf(from_user_id)<0&&p.push(from_user_id),p.indexOf(to_user_id)<0&&p.push(to_user_id)}var i=configuration.botcache_chunk_sizes;start_index=0,end_index=0;h.nodes.sort(function(e,t){return e.orig_size>t.orig_size?-1:e.orig_size<t.orig_size?1:0});var r=[];for(var t in h.nodes)r.push(h.nodes[t].id);for(t=0;t<i.length;t++){var s=i[t];start_index=end_index,end_index+=s;var a=r.slice(start_index,end_index);if(0===a.length)break;var c=axios({method:"post",url:configuration.botcache_url,responseType:"json",data:{user_id:a.join(",")}});c.then(function(e){n("getBotCacheScores"),console.debug("Got botcache: ",e.data);var t=e.data.result;for(var o in t){var i=t[o];if(i){var r=i.user.screen_name,s=i.user.id,a=0;a="en"==i.user.lang||"en-gb"==i.user.lang?i.scores.english:i.scores.universal,w[s]={score:a,old:!i.fresh,time:new Date(i.timestamp),user_id:i.user.id,screen_name:r},z(s,a)}}l.unavailable=0,l.old=0,l.found=0;var c=[],d=[],_=[],g=[];for(var o in l.user_list=[],h.nodes)(a=w[h.nodes[o].id])&&a.score?(-1===a.score?(_.push(h.nodes[o].id),l.unavailable+=1):!0===a.old?(d.push(h.nodes[o].id),l.old+=1,l.found+=1):(c.push(h.nodes[o].id),l.found+=1),a=a.score):(_.push(h.nodes[o].id),a=!1);var m=_.length;for(o=0;o<m;o++)g.push(_[o]);var f=d.length;for(o=0;o<f;o++)g.push(d[o]);for(l.current_index=c.length,o=0;o<l.current_index;o++)l.user_list.push(c[o]);for(toComputeLen=g.length,o=0;o<toComputeLen;o++)l.user_list.push(g[o]);l.total=h.nodes.length,u.running=!1},function(t){u.running=!1,console.warn("Botometer Scores Request Error: ",t);try{b<5&&(b+=1,e())}catch(e){console.warn(e)}n("getBotCacheScores")})}return c},t.getNodeColor=N,t.updateUserBotScore=x,t.zoomIn=function(){var e=m.camera;sigma.misc.animation.camera(e,{ratio:e.ratio/e.settings("zoomingRatio")},{duration:200}),e.goTo({ratio:e.ratio/e.settings("zoomingRatio")})},t.zoomOut=function(){var e=m.camera;sigma.misc.animation.camera(e,{ratio:e.ratio*e.settings("zoomingRatio")},{duration:200}),e.goTo({ratio:e.ratio*e.settings("zoomingRatio")})},t.redraw=function(){if(m&&m.camera){var e=m.camera;sigma.misc.animation.camera(e,{ratio:e.ratio},{}),e.goTo({ratio:e.ratio})}},t.getEdges=function(){return f},t.botscores=function(){return w},t.resetBotscores=function(){w={}},t.setBotScore=function(e,t){w[e]={score:t,user_id:e}},t.filterNodesByScore=function(e,t){var n=m.graph.nodes();for(var o in n){var i=n[o],r=!1;w[i.id]&&(r=w[i.id].score),e?!1!==r&&r>=t&&r<e?z(i.id,r):(i.color="rgba(0,0,0,.05)",i.borderColor="rgba(0,0,0,.05)"):z(i.id,r)}I()},t.score_stats=l,t.getRenderer=function(){return m.renderers[0]},t}